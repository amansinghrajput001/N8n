name: n8n Cloud Server

on:
  push:
    branches:
      - main      # change if your branch name is different
  workflow_dispatch:

jobs:
  n8n:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6 hours max runtime

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Use Node 20 (required for latest n8n)
      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install Cloudflare tunnel
      - name: Install Cloudflare Tunnel
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      # Start n8n temporary (local)
      - name: Start n8n temporary
        run: |
          export N8N_PORT=5678
          export N8N_HOST=0.0.0.0
          export N8N_PROTOCOL=http
          export N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false

          npx --yes -p n8n n8n start &
          sleep 40

      # Create public URL
      - name: Create Public URL
        run: |
          cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          sleep 15

          URL=$(grep -o 'https://[-a-z0-9]*\.trycloudflare.com' tunnel.log | head -n 1)

          echo "PUBLIC_URL=$URL" >> $GITHUB_ENV
          echo "==============================="
          echo "Your Public URL:"
          echo "$URL"
          echo "==============================="

      # Restart n8n with webhook URL
      - name: Restart n8n with webhook url
        env:
          PUBLIC_URL: ${{ env.PUBLIC_URL }}
        run: |
          pkill node || true
          sleep 5

          export N8N_PORT=5678
          export N8N_HOST=0.0.0.0
          export N8N_PROTOCOL=http
          export WEBHOOK_URL=$PUBLIC_URL
          export GENERIC_TIMEZONE=Asia/Kolkata
          export N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false

          npx --yes -p n8n n8n start &
          sleep 40

      # Keep server alive ~6 hours
      - name: Keep Alive
        run: |
          echo "==============================="
          echo "Your n8n URL:"
          echo $PUBLIC_URL
          echo "==============================="
          sleep 21600
