name: n8n Cloud Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  n8n:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Node 20 required by n8n
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install Cloudflare tunnel
      - name: Install Cloudflare Tunnel
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      # Start tunnel FIRST
      - name: Create Public URL
        run: |
          cloudflared tunnel --url http://localhost:5678 > tunnel.log 2>&1 &
          sleep 20

          URL=$(grep -o 'https://[-a-z0-9]*\.trycloudflare.com' tunnel.log | head -n 1)

          if [ -z "$URL" ]; then
            echo "Tunnel failed"
            cat tunnel.log
            exit 1
          fi

          echo "PUBLIC_URL=$URL" >> $GITHUB_ENV
          echo "Public URL: $URL"

      # Start n8n ONLY ONCE with webhook url
      - name: Start n8n server
        env:
          PUBLIC_URL: ${{ env.PUBLIC_URL }}
        run: |
          export N8N_PORT=5678
          export N8N_HOST=0.0.0.0
          export N8N_PROTOCOL=http
          export WEBHOOK_URL=$PUBLIC_URL
          export GENERIC_TIMEZONE=Asia/Kolkata
          export N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false

          echo "Starting n8n..."
          npx --yes -p n8n n8n start &

          echo "Waiting for n8n..."
          sleep 60

      # Show URL + keep alive
      - name: Keep Alive
        run: |
          echo "================================="
          echo "OPEN YOUR n8n HERE:"
          echo $PUBLIC_URL
          echo "================================="
          sleep 21600
